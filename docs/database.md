# データベース

データの管理・操作に関する知識です。

## 出題範囲

- SQL
- NoSQL
- データベース設計

---

## リレーショナルデータベース（RDBMS）

### 基本概念

| 用語 | 説明 |
|------|------|
| テーブル | データを格納する表（リレーション） |
| 行（レコード） | 1件のデータ（タプル） |
| 列（カラム） | データの属性（フィールド） |
| 主キー | 行を一意に識別するキー |
| 外部キー | 他テーブルを参照するキー |

### 主要なRDBMS

| 製品 | 特徴 |
|------|------|
| MySQL | オープンソース、Web系で人気 |
| PostgreSQL | 高機能、拡張性が高い |
| Oracle Database | 大規模企業向け、高信頼性 |
| SQL Server | Microsoft製、Windows親和性 |
| SQLite | 軽量、組み込み用途 |

---

## SQL

### データ操作言語（DML）

```sql
-- SELECT: データ取得
SELECT 列名 FROM テーブル名 WHERE 条件;

-- INSERT: データ挿入
INSERT INTO テーブル名 (列1, 列2) VALUES (値1, 値2);

-- UPDATE: データ更新
UPDATE テーブル名 SET 列名 = 値 WHERE 条件;

-- DELETE: データ削除
DELETE FROM テーブル名 WHERE 条件;
```

### データ定義言語（DDL）

```sql
-- CREATE: テーブル作成
CREATE TABLE テーブル名 (
  id INT PRIMARY KEY,
  name VARCHAR(100) NOT NULL
);

-- ALTER: テーブル変更
ALTER TABLE テーブル名 ADD 列名 データ型;

-- DROP: テーブル削除
DROP TABLE テーブル名;

-- TRUNCATE: データ全削除（構造は残す）
TRUNCATE TABLE テーブル名;
```

### データ制御言語（DCL）

```sql
-- GRANT: 権限付与
GRANT SELECT ON テーブル名 TO ユーザー名;

-- REVOKE: 権限剥奪
REVOKE SELECT ON テーブル名 FROM ユーザー名;
```

### トランザクション制御

```sql
-- トランザクション開始
BEGIN TRANSACTION;

-- 確定
COMMIT;

-- 取消
ROLLBACK;
```

### 結合（JOIN）

| 種類 | 説明 |
|------|------|
| INNER JOIN | 両方に存在するデータのみ |
| LEFT JOIN | 左テーブルを基準に結合 |
| RIGHT JOIN | 右テーブルを基準に結合 |
| FULL OUTER JOIN | 両方のすべてのデータ |
| CROSS JOIN | すべての組み合わせ |

```sql
-- INNER JOIN例
SELECT * FROM 社員
INNER JOIN 部署 ON 社員.部署ID = 部署.ID;
```

### 集計関数

| 関数 | 説明 |
|------|------|
| COUNT() | 件数をカウント |
| SUM() | 合計 |
| AVG() | 平均 |
| MAX() | 最大値 |
| MIN() | 最小値 |

```sql
-- GROUP BY と HAVING
SELECT 部署, COUNT(*) as 人数
FROM 社員
GROUP BY 部署
HAVING COUNT(*) >= 5;
```

---

## 正規化

データの重複を排除し、整合性を保つための設計手法。

### 正規形

| 正規形 | 条件 |
|--------|------|
| 第1正規形 | 繰り返し項目がない（原子値のみ） |
| 第2正規形 | 部分関数従属がない |
| 第3正規形 | 推移関数従属がない |
| BCNF | すべての決定項が候補キー |

### 例：正規化の過程

**非正規形**
| 注文ID | 顧客名 | 商品1 | 商品2 |
|--------|--------|-------|-------|
| 1 | 田中 | りんご | みかん |

**第1正規形**（繰り返し項目の排除）
| 注文ID | 顧客名 | 商品 |
|--------|--------|------|
| 1 | 田中 | りんご |
| 1 | 田中 | みかん |

---

## インデックス

検索を高速化するためのデータ構造。

| 種類 | 説明 |
|------|------|
| B-tree | 最も一般的、範囲検索に強い |
| Hash | 等価検索が高速 |
| Bitmap | カーディナリティが低い列向け |
| 全文検索 | テキスト検索用 |

```sql
-- インデックス作成
CREATE INDEX idx_name ON テーブル名(列名);

-- ユニークインデックス
CREATE UNIQUE INDEX idx_email ON users(email);
```

### インデックスの注意点

- 検索は高速化するが、INSERT/UPDATE/DELETEは遅くなる
- カーディナリティ（値の種類）が高い列に効果的
- 複合インデックスは列の順序が重要

---

## ACID特性

トランザクションが満たすべき4つの特性。

| 特性 | 説明 |
|------|------|
| Atomicity（原子性） | 全て実行か全て取消 |
| Consistency（一貫性） | 制約を常に満たす |
| Isolation（独立性） | 他のトランザクションから独立 |
| Durability（永続性） | 確定後はデータが永続化 |

### トランザクション分離レベル

| レベル | Dirty Read | Non-repeatable Read | Phantom Read |
|--------|------------|---------------------|--------------|
| READ UNCOMMITTED | 発生 | 発生 | 発生 |
| READ COMMITTED | 防止 | 発生 | 発生 |
| REPEATABLE READ | 防止 | 防止 | 発生 |
| SERIALIZABLE | 防止 | 防止 | 防止 |

---

## NoSQL

RDBMSとは異なるデータ構造を持つデータベース。

### 種類と特徴

| 種類 | 特徴 | 代表製品 |
|------|------|---------|
| キー・バリュー型 | 単純なKey-Value | Redis, Memcached |
| ドキュメント型 | JSON形式で格納 | MongoDB, CouchDB |
| カラム指向型 | 列単位で格納 | Cassandra, HBase |
| グラフ型 | ノードとエッジで表現 | Neo4j |

### CAP定理

分散システムでは3つのうち2つしか同時に満たせない。

| 特性 | 説明 |
|------|------|
| Consistency（一貫性） | 全ノードで同じデータ |
| Availability（可用性） | 常に応答を返す |
| Partition tolerance（分断耐性） | ネットワーク分断時も動作 |

### BASE特性

NoSQLの設計思想。ACIDの対比。

| 特性 | 説明 |
|------|------|
| Basically Available | 基本的に利用可能 |
| Soft state | 状態は常に変化しうる |
| Eventually consistent | 最終的に一貫性を保つ |

---

## データベース設計

### ER図（Entity-Relationship Diagram）

エンティティ（実体）とリレーションシップ（関係）を図示。

**カーディナリティ**
| 記号 | 意味 |
|------|------|
| 1:1 | 1対1の関係 |
| 1:N | 1対多の関係 |
| M:N | 多対多の関係 |

### 論理設計と物理設計

| 段階 | 内容 |
|------|------|
| 概念設計 | ビジネス要件からER図作成 |
| 論理設計 | RDBMS向けにテーブル定義 |
| 物理設計 | インデックス、パーティション設計 |

---

## 重要用語

| 用語 | 説明 |
|------|------|
| ビュー | 仮想テーブル（SELECT結果を表として扱う） |
| ストアドプロシージャ | DB内に保存された処理手順 |
| トリガー | イベント発生時に自動実行される処理 |
| デッドロック | 複数トランザクションの相互待ち |
| レプリケーション | データベースの複製 |
| シャーディング | データの水平分割 |
| パーティショニング | テーブルの分割 |
